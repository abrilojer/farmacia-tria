<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - Farmacia Tria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a href="index.html" class="navbar-brand"><span class="text-primary"> Farmacia </span>Tria</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbar-start" aria-controls="navbar-start" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbar-start">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalogo.html">Catalogo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mis-pedidos.html"><i class="bi bi-bag-check"></i> Mis Pedidos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contacto.html">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="bi bi-person-circle"></i> Iniciar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5 mt-5">

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h2><i class="bi bi-bag-check-fill text-primary"></i> Mis Pedidos</h2>
                <p class="text-muted">Aquí puedes ver el historial de todas tus compras</p>
                <hr>
            </div>
        </div>

        <!-- Mensaje si no hay sesión -->
        <div id="sinSesion" style="display:none;">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill"></i>
                Debes <a href="login.html" class="alert-link">iniciar sesión</a> para ver tus pedidos.
            </div>
        </div>

        <!-- Lista de Pedidos -->
        <div id="listaPedidos">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Cargando tus pedidos...</p>
            </div>
        </div>

    </div>

    <!-- Modal Detalle del Pedido -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt"></i> Detalle del Pedido <span id="modalPedidoId"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <!-- Info del pedido -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha:</strong> <span id="detalleF"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> <span id="detalleEstado"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Método de Pago:</strong> <span id="detalleMetodo"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>DNI:</strong> <span id="detalleDNI"></span>
                        </div>
                    </div>

                    <hr>

                    <!-- Productos del pedido -->
                    <h6 class="mb-3"><i class="bi bi-box-seam"></i> Productos</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="detalleProductos"></tbody>
                            <tfoot>
                                <tr class="table-dark">
                                    <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                                    <td class="text-end"><strong id="detalleTotal"></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="descargarComprobante()">
                        <i class="bi bi-download"></i> Descargar Comprobante
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://farmaciatria.rf.gd/api';

        // Recuperar usuario de sesión
        let usuarioGuardado = sessionStorage.getItem('usuarioActual');
        if (usuarioGuardado) {
            window.usuarioActual = JSON.parse(usuarioGuardado);
            console.log('✅ Usuario:', window.usuarioActual);
        } else {
            window.usuarioActual = null;
            console.log('❌ No hay sesión');
        }

        // Actualizar navbar con usuario
        function actualizarNavbar() {
            if (window.usuarioActual && window.usuarioActual.correo) {
                const navLinks = document.querySelectorAll('.navbar-nav');
                navLinks.forEach(nav => {
                    const loginLink = nav.querySelector('a[href="login.html"]');
                    if (loginLink) {
                        loginLink.innerHTML = `<i class="bi bi-person-check-fill"></i> ${window.usuarioActual.correo}`;
                        loginLink.style.color = '#28a745';
                        loginLink.style.fontWeight = 'bold';
                        loginLink.href = '#';

                        loginLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (confirm('¿Deseas cerrar sesión?')) {
                                sessionStorage.removeItem('usuarioActual');
                                window.location.href = 'login.html';
                            }
                        });
                    }
                });
            }
        }

        // Cargar pedidos del usuario
        function cargarPedidos() {
            if (!window.usuarioActual || !window.usuarioActual.id) {
                document.getElementById('listaPedidos').style.display = 'none';
                document.getElementById('sinSesion').style.display = 'block';
                return;
            }

            fetch(`${API_URL}/mis_pedidos.php?usuario_id=${window.usuarioActual.id}`)
                .then(response => response.json())
                .then(pedidos => {
                    const container = document.getElementById('listaPedidos');

                    if (pedidos.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
                                <h5>No tienes pedidos aún</h5>
                                <p>Cuando realices tu primera compra, aparecerá aquí.</p>
                                <a href="catalogo.html" class="btn btn-primary">
                                    <i class="bi bi-cart"></i> Ir al Catálogo
                                </a>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = '';

                    pedidos.forEach(pedido => {
                        const fecha = new Date(pedido.fecha_pedido).toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const badgeColor = {
                            'pendiente': 'warning',
                            'procesando': 'info',
                            'enviado': 'primary',
                            'entregado': 'success',
                            'cancelado': 'danger'
                        };

                        const card = document.createElement('div');
                        card.className = 'card mb-3 shadow-sm';
                        card.innerHTML = `
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <h5 class="text-primary mb-0">
                                            <i class="bi bi-receipt-cutoff"></i> #${pedido.id_pedido}
                                        </h5>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted d-block">Fecha</small>
                                        <strong>${fecha}</strong>
                                    </div>
                                    <div class="col-md-2">
                                        <small class="text-muted d-block">Estado</small>
                                        <span class="badge bg-${badgeColor[pedido.estado_pedido] || 'secondary'}">
                                            ${pedido.estado_pedido}
                                        </span>
                                    </div>
                                    <div class="col-md-2">
                                        <small class="text-muted d-block">Total</small>
                                        <strong class="text-success fs-5">$${pedido.total}</strong>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button class="btn btn-outline-primary btn-sm" onclick="verDetalle(${pedido.id_pedido})">
                                            <i class="bi bi-eye"></i> Ver Detalle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('listaPedidos').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error al cargar los pedidos.
                            <button class="btn btn-sm btn-danger" onclick="cargarPedidos()">Reintentar</button>
                        </div>
                    `;
                });
        }

        // Ver detalle de un pedido
        function verDetalle(pedidoId) {
            fetch(`${API_URL}/detalle_pedido.php?pedido_id=${pedidoId}`)
                .then(response => response.json())
                .then(data => {
                    // Info general
                    document.getElementById('modalPedidoId').textContent = `#${data.pedido.id_pedido}`;

                    const fecha = new Date(data.pedido.fecha_pedido).toLocaleDateString('es-AR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    document.getElementById('detalleF').textContent = fecha;
                    document.getElementById('detalleEstado').innerHTML = `<span class="badge bg-info">${data.pedido.estado_pedido}</span>`;
                    document.getElementById('detalleMetodo').textContent = data.pago.metodo_pago || 'N/A';
                    document.getElementById('detalleDNI').textContent = data.pago.dni || 'N/A';
                    document.getElementById('detalleTotal').textContent = `$${data.pedido.total}`;

                    // Productos
                    const tbody = document.getElementById('detalleProductos');
                    tbody.innerHTML = '';

                    data.productos.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${item.nombre_producto}</td>
                                <td class="text-center">${item.cantidad}</td>
                                <td class="text-end">$${item.precio_unitario}</td>
                                <td class="text-end">$${item.subtotal}</td>
                            </tr>
                        `;
                    });

                    // Mostrar modal
                    new bootstrap.Modal(document.getElementById('modalDetalle')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el detalle del pedido');
                });
        }

        // Descargar comprobante (simulado)
        function descargarComprobante() {
            alert('Generando comprobante...\n(En una versión completa, esto descargaría un PDF)');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            actualizarNavbar();
            cargarPedidos();
        });
    </script>

</body>
</html>